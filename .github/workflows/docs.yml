name: Deploy Documentation

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

# Allow only one concurrent deployment, skipping runs queued between the run in-progress and latest queued.
# However, do NOT cancel in-progress runs as we want to allow these production deployments to complete.
concurrency:
  group: "pages"
  cancel-in-progress: false

permissions:
  contents: write
  pages: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup pnpm
      uses: pnpm/action-setup@v3
      with:
        version: latest
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22'
        cache: 'pnpm'
        
    - name: Install dependencies
      run: pnpm install --frozen-lockfile --ignore-scripts
      
    - name: Build TypeScript
      run: pnpm run build
      
    - name: Generate API documentation
      run: pnpm run docs:build
      
    - name: Setup Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.2'
        bundler-cache: true
        working-directory: docs
        
    - name: Validate Build Environment
      run: |
        echo "üîç Validating build environment..."
        
        # Check Ruby version
        RUBY_VERSION=$(ruby -e 'puts RUBY_VERSION')
        echo "Ruby version: $RUBY_VERSION"
        
        # Check Bundler version
        BUNDLER_VERSION=$(bundle --version)
        echo "Bundler version: $BUNDLER_VERSION"
        
        # Verify all gems are installed
        if bundle check; then
          echo "‚úÖ All dependencies satisfied"
        else
          echo "‚ùå Missing dependencies"
          exit 1
        fi
      working-directory: docs
        
    - name: Install Jekyll dependencies
      run: bundle install
      working-directory: docs
        
    - name: Verify Jekyll Version
      run: |
        echo "Checking Jekyll version..."
        JEKYLL_VERSION=$(bundle exec jekyll --version | cut -d' ' -f2)
        echo "Installed Jekyll version: $JEKYLL_VERSION"
        EXPECTED_VERSION="4.4.1"
        
        if [[ "$JEKYLL_VERSION" == "$EXPECTED_VERSION" ]]; then
          echo "‚úÖ Jekyll version matches expected: $EXPECTED_VERSION"
        else
          echo "‚ùå Jekyll version mismatch. Expected: $EXPECTED_VERSION, Got: $JEKYLL_VERSION"
          exit 1
        fi
      working-directory: docs
        
    - name: Build Jekyll site
      run: bundle exec jekyll build --baseurl="/node-syslog"
      working-directory: docs
        
    - name: Add .nojekyll to build output
      run: |
        # Ensure .nojekyll file exists in build output to disable GitHub Pages Jekyll processing
        touch _site/.nojekyll
        echo "‚úÖ Added .nojekyll to disable GitHub Pages Jekyll processing"
      working-directory: docs
        
    - name: Validate Jekyll Build
      run: |
        echo "üîç Validating Jekyll build output..."
        
        # Check essential files exist
        REQUIRED_FILES=("index.html" "api/index.html" ".nojekyll")
        for file in "${REQUIRED_FILES[@]}"; do
          if [[ -f "_site/$file" ]]; then
            echo "‚úÖ $file found"
          else
            echo "‚ùå $file missing"
            exit 1
          fi
        done
        
        echo "‚úÖ Build validation complete"
      working-directory: docs
        
    - name: Deploy to GitHub Pages
      if: github.ref == 'refs/heads/main'
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./docs/_site
        publish_branch: gh-pages
        keep_files: false

  