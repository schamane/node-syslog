name: Deploy Documentation

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

# Allow only one concurrent deployment, skipping runs queued between the run in-progress and latest queued.
# However, do NOT cancel in-progress runs as we want to allow these production deployments to complete.
concurrency:
  group: "pages"
  cancel-in-progress: false

permissions:
  contents: write
  pages: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup pnpm
      uses: pnpm/action-setup@v3
      with:
        version: latest
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22'
        cache: 'pnpm'
        
    - name: Install dependencies
      run: pnpm install --frozen-lockfile --ignore-scripts
      
    - name: Build TypeScript
      run: pnpm run build
      
    - name: Generate API documentation
      run: pnpm run docs:build
      
    - name: Setup Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.2'
        bundler-cache: true
        working-directory: docs
        
    - name: Validate Build Environment
      run: |
        echo "üîç Validating build environment..."
        
        # Check Ruby version
        RUBY_VERSION=$(ruby -e 'puts RUBY_VERSION')
        echo "Ruby version: $RUBY_VERSION"
        
        # Check Bundler version
        BUNDLER_VERSION=$(bundle --version)
        echo "Bundler version: $BUNDLER_VERSION"
        
        # Verify all gems are installed
        if bundle check; then
          echo "‚úÖ All dependencies satisfied"
        else
          echo "‚ùå Missing dependencies"
          exit 1
        fi
      working-directory: docs
        
    - name: Install Jekyll dependencies
      run: bundle install
      working-directory: docs
      
    - name: Update just-the-docs to latest
      run: |
        echo "üîÑ Updating just-the-docs to latest patch version..."
        bundle update just-the-docs
        echo "‚úÖ just-the-docs updated successfully"
      working-directory: docs
        
    - name: Verify Jekyll and just-the-docs versions
      run: |
        echo "Checking Jekyll version..."
        JEKYLL_VERSION=$(bundle exec jekyll --version | cut -d' ' -f2)
        echo "Installed Jekyll version: $JEKYLL_VERSION"
        EXPECTED_JEKYLL="4.4.1"
        
        if [[ "$JEKYLL_VERSION" == "$EXPECTED_JEKYLL" ]]; then
          echo "‚úÖ Jekyll version matches expected: $EXPECTED_JEKYLL"
        else
          echo "‚ùå Jekyll version mismatch. Expected: $EXPECTED_JEKYLL, Got: $JEKYLL_VERSION"
          exit 1
        fi
        
        echo "Checking just-the-docs version..."
        JTD_VERSION=$(bundle list | grep just-the-docs | awk '{print $2}')
        echo "Installed just-the-docs version: $JTD_VERSION"
        echo "‚úÖ just-the-docs version verified"
      working-directory: docs
        
    - name: Build Jekyll site
      run: bundle exec jekyll build --baseurl="/node-syslog"
      working-directory: docs
      
    - name: Add .nojekyll to prevent GitHub Pages rebuild
      run: |
        # Add .nojekyll to prevent GitHub Pages from rebuilding
        touch _site/.nojekyll
        echo "‚úÖ Added .nojekyll to prevent GitHub Pages rebuild"
      working-directory: docs
        
    - name: Verify .nojekyll configuration
      run: |
        # Ensure .nojekyll exists to prevent GitHub Pages from rebuilding
        if [[ -f "_site/.nojekyll" ]]; then
          echo "‚úÖ .nojekyll exists - GitHub Pages will serve pre-built site"
        else
          echo "‚ùå .nojekyll missing - GitHub Pages might try to rebuild"
          exit 1
        fi
        
        # Remove any .nojekyll files in subdirectories that might interfere
        if [[ -f "_site/api/.nojekyll" ]]; then
          rm _site/api/.nojekyll
          echo "‚úÖ Removed api/.nojekyll to prevent conflicts"
        fi
        echo "‚úÖ .nojekyll configuration verified"
      working-directory: docs
        
    - name: Validate Jekyll Build
      run: |
        echo "üîç Validating Jekyll build output..."
        
        # List all generated HTML files
        echo "üìÅ Generated HTML files:"
        find _site -name "*.html" -type f | sort
        
        # List all generated assets
        echo "üìÅ Generated assets:"
        find _site -name "*.css" -o -name "*.js" -o -name "*.svg" -o -name "*.png" | sort
        
        # List all directories in _site
        echo "üìÅ All directories in _site:"
        find _site -type d | sort
        
        # Show expected URL structure
        echo "üåê Expected URL structure:"
        echo "  / (index.html)"
        echo "  /getting-started/"
        echo "  /installation/"
        echo "  /api/ (TypeDoc collection)"
        echo "  /examples/"
        
        # Check essential files exist
        REQUIRED_FILES=("index.html" "api/index.html")
        for file in "${REQUIRED_FILES[@]}"; do
          if [[ -f "_site/$file" ]]; then
            echo "‚úÖ $file found"
          else
            echo "‚ùå $file missing"
            exit 1
          fi
        done
        
        echo "‚úÖ Build validation complete"
      working-directory: docs
        
    - name: Deploy to GitHub Pages
      if: github.ref == 'refs/heads/main'
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./docs/_site
        publish_branch: gh-pages
        keep_files: false
        
    - name: List deployed files
      if: github.ref == 'refs/heads/main'
      run: |
        echo "üìÅ Files deployed to gh-pages:"
        # This would show what's actually on the gh-pages branch
        echo "Check deployed files at: https://schamane.github.io/node-syslog/"

  